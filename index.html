<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BiomCYL</title>

    <!-- Apple Touch Icon for iOS bookmarks -->
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png?v=0.3.3">

    <!-- Standard favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png?v=0.3.3">

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json?v=0.3.3">

    <!-- SVG favicon for modern browsers -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><line x1='10' y1='38' x2='38' y2='38' stroke='%234A90E2' stroke-width='3' stroke-linecap='round'/><line x1='10' y1='38' x2='24' y2='12' stroke='%234A90E2' stroke-width='3' stroke-linecap='round'/><path d='M 16 38 A 8 8 0 0 1 13.5 31' fill='none' stroke='%234A90E2' stroke-width='2'/><text x='20' y='35' font-size='12' fill='%234A90E2' font-family='Arial'>θ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css?v=0.3.3">
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <div class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-xl sm:rounded-xl sm:my-8 sm:min-h-0 sm:overflow-hidden">

        <!-- App Header -->
        <header class="bg-blue-600 px-5 py-4 flex items-center justify-between shadow-sm shrink-0">
            <div class="flex justify-between items-center w-full">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="w-8 h-8 shrink-0">
                        <line x1="10" y1="38" x2="38" y2="38" stroke="white" stroke-width="3" stroke-linecap="round"/>
                        <line x1="10" y1="38" x2="24" y2="12" stroke="white" stroke-width="3" stroke-linecap="round"/>
                        <path d="M 22 38 A 12 12 0 0 0 14.5 28" fill="none" stroke="white" stroke-width="2.5"/>
                    </svg>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">BiomCYL</h1>
                        <p class="text-xs text-blue-100 opacity-90">Corneal Astigmatism Analysis</p>
                    </div>
                </div>
                <button onclick="resetForm()" class="p-2 text-blue-100 hover:text-white transition-colors rounded-full hover:bg-blue-700" title="Clear Form">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Scrollable Content -->
        <main class="flex-grow overflow-y-auto px-5 py-6 space-y-6">

            <!-- BiomPIN Load Section -->
            <section class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 rounded-xl px-5 py-4 space-y-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xs font-bold uppercase text-gray-600 tracking-wider">Load from BiomPIN</h2>
                        <p class="text-[9px] text-gray-500 mt-0.5">Import biometry data from BiomAPI</p>
                    </div>
                </div>

                <div class="flex gap-2">
                    <div class="flex-1 relative">
                        <input
                            type="text"
                            id="biomPinInput"
                            placeholder="word-word-123456 or paste URL"
                            aria-label="Enter BiomPIN or paste BiomAPI URL"
                            class="w-full py-2.5 px-3 bg-white border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm text-gray-900 placeholder-gray-400"
                        >
                    </div>
                    <button
                        type="button"
                        id="loadBiomPinBtn"
                        onclick="loadBiomPIN()"
                        aria-label="Load biometry data from BiomPIN"
                        class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold text-sm rounded-lg transition-all shadow-sm hover:shadow disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-blue-600"
                    >
                        <span id="loadBtnText">Load</span>
                        <span id="loadBtnSpinner" class="hidden">
                            <svg class="animate-spin h-4 w-4 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>

                <!-- Message Area -->
                <div id="biomPinMessage" role="status" aria-live="polite" class="hidden text-xs px-3 py-2 rounded-lg"></div>
            </section>

            <!-- Patient Section -->
            <section class="space-y-4">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-bold uppercase text-gray-400 tracking-wider">Patient</h2>
                </div>

                <!-- Patient Name -->
                <div class="relative">
                    <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">Patient Name</label>
                    <input type="text" id="patientName" placeholder="Enter name"
                        class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-base text-gray-900 placeholder-gray-300">
                </div>

                <!-- Patient ID -->
                <div class="relative">
                    <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">Patient ID</label>
                    <input type="text" id="patientId" placeholder="Enter ID"
                        class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-base text-gray-900 placeholder-gray-300">
                </div>
            </section>

            <hr class="border-gray-100">

            <!-- Eye Selector Section -->
            <section class="space-y-4">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-bold uppercase text-gray-400 tracking-wider">Eye</h2>
                </div>
                <div>
                    <div class="flex gap-2">
                        <button type="button" id="eyeRight" onclick="selectEye('right')"
                            class="flex-1 py-2.5 px-4 rounded-lg border-2 border-gray-200 bg-gray-50 text-gray-600 font-semibold text-sm transition-all hover:border-blue-400 focus:outline-none">
                            Right (OD)
                        </button>
                        <button type="button" id="eyeLeft" onclick="selectEye('left')"
                            class="flex-1 py-2.5 px-4 rounded-lg border-2 border-gray-200 bg-gray-50 text-gray-600 font-semibold text-sm transition-all hover:border-blue-400 focus:outline-none">
                            Left (OS)
                        </button>
                    </div>
                </div>
            </section>

            <hr class="border-gray-100">

            <!-- Inputs Section -->
            <section class="space-y-4">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h2 class="text-xs font-bold uppercase text-gray-400 tracking-wider">Anterior Keratometry</h2>
                        <p class="text-[9px] text-gray-400 mt-0.5">(n=1.3375)</p>
                    </div>
                </div>

                <!-- Anterior Row 1: K1 (Flat) -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">K1 (D)</label>
                        <input type="text" id="kFlat" placeholder="-" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                            class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-lg font-medium text-gray-900 placeholder-gray-300">
                    </div>
                    <div class="relative">
                        <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">K1 Axis (°)</label>
                        <input type="number" id="axisFlat" min="0" max="180" step="1" placeholder="-" inputmode="numeric"
                            class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-lg font-medium text-gray-900 placeholder-gray-300">
                    </div>
                </div>

                <!-- Anterior Row 2: K2 (Steep) -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">K2 (D)</label>
                        <input type="text" id="kSteep" placeholder="-" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                            class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-lg font-medium text-gray-900 placeholder-gray-300">
                    </div>
                    <div class="relative">
                        <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">K2 Axis (°)</label>
                        <input type="number" id="axisSteep" min="0" max="180" step="1" placeholder="-" inputmode="numeric"
                            class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-lg font-medium text-gray-900 placeholder-gray-300">
                    </div>
                </div>

                <!-- Add Measured Data Button -->
                <div id="addMeasuredContainer" class="text-center pt-2">
                    <button onclick="toggleMeasured()" class="text-xs font-semibold text-blue-600 hover:text-blue-800">
                        + add measured posterior keratometry (PK)
                    </button>
                </div>

                <!-- Measured Posterior Inputs (Hidden by default) -->
                <div id="posteriorInputs" class="hidden space-y-4 pt-4 border-t border-gray-100 slide-down relative">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h2 class="text-xs font-bold uppercase text-gray-400 tracking-wider">Posterior Keratometry</h2>
                            <p class="text-[9px] text-gray-400 mt-0.5">(only valid for the Zeiss IOLMaster 700)</p>
                        </div>
                        <button onclick="resetAndHidePK()" class="text-[10px] font-semibold text-red-500 hover:text-red-700">
                            × reset and hide PK
                        </button>
                    </div>

                    <!-- Post Row 1: PK1 (Flat) -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">PK1 (D)</label>
                            <input type="text" id="pkFlat" placeholder="-" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-lg font-medium text-gray-900 placeholder-gray-300">
                        </div>
                        <div class="relative">
                            <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">PK1 Axis (°)</label>
                            <input type="number" id="pAxisFlat" min="0" max="180" step="1" placeholder="-" inputmode="numeric"
                                class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-lg font-medium text-gray-900 placeholder-gray-300">
                        </div>
                    </div>

                    <!-- Post Row 2: PK2 (Steep) -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">PK2 (D)</label>
                            <input type="text" id="pkSteep" placeholder="-" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*"
                                class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-lg font-medium text-gray-900 placeholder-gray-300">
                        </div>
                        <div class="relative">
                            <label class="absolute text-[10px] font-semibold text-gray-500 top-2 left-3 uppercase">PK2 Axis (°)</label>
                            <input type="number" id="pAxisSteep" min="0" max="180" step="1" placeholder="-" inputmode="numeric"
                                class="w-full pt-6 pb-2 px-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-lg font-medium text-gray-900 placeholder-gray-300">
                        </div>
                    </div>
                </div>
            </section>

            <hr class="border-gray-100">

            <!-- Results Section -->
            <section id="analysisSection" class="space-y-4 hidden">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-bold uppercase text-gray-400 tracking-wider">Analysis</h2>
                </div>

                <!-- Unified Analysis Card -->
                <div class="analysis-card bg-white border border-gray-200 rounded-xl p-5 shadow-sm">

                    <!-- TOP SECTION: Raw Keratometry Values -->
                    <div class="space-y-3">
                        <!-- K1 / K2 Row -->
                        <div class="grid grid-cols-2 gap-6">
                            <div class="keratometry-value">
                                <div class="text-[10px] text-gray-400 uppercase font-semibold tracking-wide">K1</div>
                                <div class="font-mono text-base text-gray-800 font-medium"><span id="dispK1">--</span> D <span class="text-gray-400">@</span> <span id="dispK1Axis">--</span>°</div>
                            </div>
                            <div class="keratometry-value">
                                <div class="text-[10px] text-gray-400 uppercase font-semibold tracking-wide">K2</div>
                                <div class="font-mono text-base text-gray-800 font-medium"><span id="dispK2">--</span> D <span class="text-gray-400">@</span> <span id="dispK2Axis">--</span>°</div>
                            </div>
                        </div>

                        <!-- TK1 / TK2 Row (Conditional) -->
                        <div id="tkValuesRow" class="hidden grid grid-cols-2 gap-6">
                            <div class="keratometry-value">
                                <div class="text-[10px] text-indigo-500 uppercase font-semibold tracking-wide">TK1</div>
                                <div class="font-mono text-base text-gray-800 font-medium"><span id="resTk1">--</span> D <span class="text-gray-400">@</span> <span id="resTk1Axis">--</span>°</div>
                            </div>
                            <div class="keratometry-value">
                                <div class="text-[10px] text-indigo-500 uppercase font-semibold tracking-wide">TK2</div>
                                <div class="font-mono text-base text-gray-800 font-medium"><span id="resTk2">--</span> D <span class="text-gray-400">@</span> <span id="resTk2Axis">--</span>°</div>
                            </div>
                        </div>

                        <!-- PK1 / PK2 Row (Conditional) -->
                        <div id="pkValuesRow" class="hidden grid grid-cols-2 gap-6">
                            <div class="keratometry-value">
                                <div class="text-[10px] text-gray-400 uppercase font-semibold tracking-wide">PK1</div>
                                <div class="font-mono text-base text-gray-800 font-medium"><span id="dispPk1">--</span> D <span class="text-gray-400">@</span> <span id="dispPk1Axis">--</span>°</div>
                            </div>
                            <div class="keratometry-value">
                                <div class="text-[10px] text-gray-400 uppercase font-semibold tracking-wide">PK2</div>
                                <div class="font-mono text-base text-gray-800 font-medium"><span id="dispPk2">--</span> D <span class="text-gray-400">@</span> <span id="dispPk2Axis">--</span>°</div>
                            </div>
                        </div>
                    </div>

                    <!-- DIVIDER -->
                    <div class="my-4 border-t border-gray-200"></div>

                    <!-- BOTTOM SECTION: Delta Values (Centered Table) -->
                    <div class="flex justify-center">
                        <div class="inline-grid delta-grid items-center gap-y-2" style="grid-template-columns: auto auto auto auto;">
                            <!-- ΔK Row -->
                            <span class="text-base font-bold text-gray-500 text-right pr-3">ΔK</span>
                            <span class="font-mono text-base font-semibold text-gray-800 text-left" id="resMeasMag">-- D</span>
                            <span class="font-mono text-base text-gray-500 text-left pl-2" id="resMeasAxis">@ --°</span>
                            <span class="pl-4 flex items-center"><span id="axisTypeBadge" class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 hidden uppercase tracking-wider">--</span></span>

                            <!-- ΔTK Row (Conditional) -->
                            <span id="deltaTkLabel" class="hidden text-base font-bold text-indigo-500 text-right pr-3">ΔTK</span>
                            <span id="resTkNetMag" class="hidden font-mono text-base font-semibold text-gray-800 text-left">-- D</span>
                            <span id="resTkNetAxis" class="hidden font-mono text-base text-gray-500 text-left pl-2">@ --°</span>
                            <span id="deltaTkSpacer" class="hidden pl-4"></span>

                            <!-- ΔSO Row -->
                            <span class="text-base font-bold text-blue-500 text-right pr-3">ΔSO</span>
                            <span class="font-mono text-base font-semibold text-gray-800 text-left" id="resSoMag">-- D</span>
                            <span class="font-mono text-base text-gray-500 text-left pl-2" id="resSoAxis">@ --°</span>
                            <span class="pl-4"></span>

                            <!-- ΔAK Row -->
                            <span class="text-base font-bold text-blue-500 text-right pr-3">ΔAK</span>
                            <span class="font-mono text-base font-semibold text-gray-800 text-left" id="resAkMag">-- D</span>
                            <span class="font-mono text-base text-gray-500 text-left pl-2" id="resAkAxis">@ --°</span>
                            <span class="pl-4"></span>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <p class="text-[9px] text-gray-400 leading-relaxed">
                            <span id="deltaTkLegend" class="hidden"><strong class="text-gray-500">ΔTK</strong> total keratometry (corrected with measured PK)<br></span>
                            <strong class="text-gray-500">ΔSO</strong> optimized by the Savini method (<a href="https://doi.org/10.1016/j.jcrs.2017.06.040" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">JCRS 2017</a>)<br>
                            <strong class="text-gray-500">ΔAK</strong> optimized by the Abulafia-Koch regression (<a href="https://doi.org/10.1016/j.jcrs.2016.02.038" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">JCRS 2016</a>)
                        </p>
                    </div>
                </div>

            </section>
        </main>

        <footer class="px-5 py-4 bg-gray-50 border-t border-gray-100 text-[10px] text-gray-400 text-center">
            <p class="font-semibold">BiomCYL 0.3.3</p>
            <p>Developed by Miguel Raimundo</p>
        </footer>
    </div>

    <script src="script.js?v=0.3.3"></script>
</body>
</html>
